# =============================================================================
# dbt Daily Build Workflow
# =============================================================================
# Runs dbt transformations on a schedule and on manual trigger.
# 
# Prerequisites:
#   1. Create a GCP Service Account with BigQuery permissions
#   2. Add the JSON key as GitHub Secret: GCP_SA_KEY
# =============================================================================

name: dbt Daily Build

on:
  # Daily schedule at 07:00 UTC (14:00 WIB)
  schedule:
    - cron: '0 7 * * *'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      full_refresh:
        description: 'Run with --full-refresh flag'
        required: false
        default: 'false'
        type: boolean

env:
  DBT_PROJECT_DIR: src/dbt
  GCP_PROJECT_ID: dataengineergcp-482812
  GCP_REGION: asia-southeast2

jobs:
  dbt-build:
    name: dbt Build & Test
    runs-on: ubuntu-latest
    
    steps:
      # ----------------------------------------------------------------------
      # Checkout Repository
      # ----------------------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # Authenticate to Google Cloud
      # ----------------------------------------------------------------------
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      # ----------------------------------------------------------------------
      # Setup Python & dbt
      # ----------------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: ${{ env.DBT_PROJECT_DIR }}/requirements.txt

      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-bigquery

      # ----------------------------------------------------------------------
      # Configure dbt Profile
      # ----------------------------------------------------------------------
      - name: Create dbt Profile
        run: |
          mkdir -p ~/.dbt
          cat << EOF > ~/.dbt/profiles.yml
          ecommerce_dw:
            target: prod
            outputs:
              prod:
                type: bigquery
                method: oauth
                project: ${{ env.GCP_PROJECT_ID }}
                dataset: ecommerce_dw
                location: ${{ env.GCP_REGION }}
                threads: 4
                timeout_seconds: 300
                priority: batch
          EOF

      # ----------------------------------------------------------------------
      # dbt Commands
      # ----------------------------------------------------------------------
      - name: Install dbt Packages
        working-directory: ${{ env.DBT_PROJECT_DIR }}
        run: dbt deps

      - name: dbt Debug
        working-directory: ${{ env.DBT_PROJECT_DIR }}
        run: dbt debug

      - name: dbt Build
        working-directory: ${{ env.DBT_PROJECT_DIR }}
        run: |
          if [ "${{ github.event.inputs.full_refresh }}" == "true" ]; then
            echo "Running with --full-refresh"
            dbt build --full-refresh
          else
            dbt build
          fi

      - name: dbt Test
        working-directory: ${{ env.DBT_PROJECT_DIR }}
        run: dbt test
        # This will fail the workflow if any test fails

      # ----------------------------------------------------------------------
      # Generate Artifacts
      # ----------------------------------------------------------------------
      - name: Generate dbt Docs
        working-directory: ${{ env.DBT_PROJECT_DIR }}
        run: dbt docs generate

      - name: Upload dbt Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dbt-artifacts
          path: |
            ${{ env.DBT_PROJECT_DIR }}/target/manifest.json
            ${{ env.DBT_PROJECT_DIR }}/target/run_results.json
            ${{ env.DBT_PROJECT_DIR }}/target/catalog.json
          retention-days: 7

      # ----------------------------------------------------------------------
      # Notifications (Optional)
      # ----------------------------------------------------------------------
      - name: Build Summary
        if: always()
        run: |
          echo "## dbt Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** ${{ env.GCP_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dataset:** ecommerce_dw" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
